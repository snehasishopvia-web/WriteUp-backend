/**
 * Migration: Create users table
 *
 * Creates users table with:
 * - Nullable email (unique constraint only for non-null emails)
 * - temp_email flag to track system-generated emails
 * - subject field for teachers
 * - Soft delete fields (deleted_at, deleted_by, deletion_reason)
 * - References to accounts and schools
 *
 * @type {import('node-pg-migrate').ColumnDefinitions | undefined}
 */
const shorthands = undefined;

/**
 * @param pgm {import('node-pg-migrate').MigrationBuilder}
 * @param run {() => void | undefined}
 * @returns {Promise<void> | void}
 */
const up = (pgm) => {
  pgm.createTable('users', {
    id: {
      type: 'uuid',
      primaryKey: true,
      default: pgm.func('gen_random_uuid()')
    },
    username: {
      type: 'varchar(150)',
      notNull: true,
      unique: true
    },
    email: {
      type: 'varchar(254)',
      notNull: false  // Nullable for bulk uploads
    },
    temp_email: {
      type: 'boolean',
      notNull: true,
      default: false,
      comment: 'True if email was auto-generated by system during bulk upload'
    },
    password: {
      type: 'varchar(128)',
      notNull: true
    },
    first_name: {
      type: 'varchar(150)',
      notNull: false
    },
    last_name: {
      type: 'varchar(150)',
      notNull: false
    },
    user_type: {
      type: 'varchar(20)',
      notNull: true
    },
    subject: {
      type: 'varchar(100)',
      notNull: false,
      comment: 'Subject taught by teacher (for user_type=teacher)'
    },
    account_id: {
      type: 'uuid',
      notNull: false,
      references: 'accounts',
      onDelete: 'CASCADE'
    },
    school_id: {
      type: 'uuid',
      notNull: false,
      references: 'schools',
      onDelete: 'CASCADE'
    },
    phone: {
      type: 'varchar(20)',
      notNull: false
    },
    date_of_birth: {
      type: 'date',
      notNull: false
    },
    gender: {
      type: 'varchar(10)',
      notNull: false
    },
    profile_picture: {
      type: 'varchar(255)',
      notNull: false
    },
    address: {
      type: 'text',
      notNull: false
    },
    emergency_contact_name: {
      type: 'varchar(200)',
      notNull: false
    },
    emergency_contact_phone: {
      type: 'varchar(20)',
      notNull: false
    },
    emergency_contact_relation: {
      type: 'varchar(50)',
      notNull: false
    },
    timezone: {
      type: 'varchar(50)',
      notNull: true,
      default: 'UTC'
    },
    language: {
      type: 'varchar(10)',
      notNull: true,
      default: 'en'
    },
    last_login_ip: {
      type: 'inet',
      notNull: false
    },
    is_active: {
      type: 'boolean',
      notNull: true,
      default: true,
      comment: 'Active status of user account'
    },
    is_staff: {
      type: 'boolean',
      notNull: true,
      default: false
    },
    is_superuser: {
      type: 'boolean',
      notNull: true,
      default: false
    },
    // Soft delete fields
    deleted_at: {
      type: 'timestamp',
      notNull: false,
      comment: 'Timestamp when the user was soft deleted'
    },
    deleted_by: {
      type: 'uuid',
      notNull: false,
      references: 'users',
      onDelete: 'SET NULL',
      comment: 'Admin user who performed the deletion'
    },
    deletion_reason: {
      type: 'text',
      notNull: false,
      comment: 'Optional reason for user deletion'
    },
    last_login: {
      type: 'timestamp',
      notNull: false
    },
    date_joined: {
      type: 'timestamp',
      notNull: true,
      default: pgm.func('current_timestamp')
    },
    created_at: {
      type: 'timestamp',
      notNull: true,
      default: pgm.func('current_timestamp')
    },
    updated_at: {
      type: 'timestamp',
      notNull: true,
      default: pgm.func('current_timestamp')
    }
  });

  // Add unique constraint on email (only for non-null emails)
  pgm.addConstraint('users', 'users_email_key', {
    unique: 'email',
    where: 'email IS NOT NULL'
  });

  // Create indexes
  pgm.createIndex('users', 'email');
  pgm.createIndex('users', 'username');
  pgm.createIndex('users', 'user_type');
  pgm.createIndex('users', 'school_id');
  pgm.createIndex('users', 'account_id');
  pgm.createIndex('users', 'temp_email');
  pgm.createIndex('users', ['school_id', 'user_type', 'is_active']);
  pgm.createIndex('users', ['account_id', 'user_type']);

  // Soft delete indexes
  pgm.createIndex('users', 'deleted_at', {
    name: 'idx_users_deleted_at',
    where: 'deleted_at IS NOT NULL'
  });
  pgm.createIndex('users', ['is_active', 'deleted_at'], {
    name: 'idx_users_active_deleted',
    where: 'deleted_at IS NULL'
  });
  pgm.createIndex('users', ['school_id', 'is_active', 'deleted_at'], {
    name: 'idx_users_school_active_deleted'
  });

  // Check constraint for user_type
  pgm.addConstraint('users', 'users_user_type_check', {
    check: "user_type IN ('admin', 'teacher', 'student', 'parent', 'staff')"
  });
};

/**
 * @param pgm {import('node-pg-migrate').MigrationBuilder}
 * @param run {() => void | undefined}
 * @returns {Promise<void> | void}
 */
const down = (pgm) => {
  pgm.dropTable('users');
};

module.exports = {
  shorthands,
  up,
  down,
};
